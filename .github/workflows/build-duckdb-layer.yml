name: Build DuckDB Lambda Layer

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build DuckDB on Lambda Python 3.9
        run: |
          docker run --rm \
            --entrypoint bash \
            -v "${{ github.workspace }}:/var/task" \
            public.ecr.aws/lambda/python:3.9 \
            -c "
              set -e
              cd /var/task
              mkdir -p python
              pip install duckdb -t python
              python -c \"import zipfile, os; z=zipfile.ZipFile('duckdb-layer.zip','w',zipfile.ZIP_DEFLATED); \
              [z.write(os.path.join(r,f), os.path.join(r,f)) for r,_,fs in os.walk('python') for f in fs]; z.close()\"
            "

      - name: Upload layer zip
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-layer
          path: duckdb-layer.zip

